trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

schedules:
  - cron: "0 0 * * *"
    displayName: Daily midnight test run
    branches:
      include:
        - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '18.x'
  BASE_URL: 'https://demo.nopcommerce.com'

stages:
  - stage: Test
    displayName: 'Run Playwright Tests'
    jobs:
      - job: TestOnCloud
        displayName: 'Test on Microsoft Playwright Testing Cloud'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npm run lint
            displayName: 'Run ESLint'
            continueOnError: true
          
          - script: npm run test:cloud
            displayName: 'Run Playwright tests on cloud'
            env:
              PLAYWRIGHT_SERVICE_URL: $(PLAYWRIGHT_SERVICE_URL)
              PLAYWRIGHT_SERVICE_ACCESS_TOKEN: $(PLAYWRIGHT_SERVICE_ACCESS_TOKEN)
              BASE_URL: $(BASE_URL)
              CI: true
              AZURE_PIPELINE_BUILD_ID: $(Build.BuildId)
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/junit.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Playwright Tests - $(Build.BuildNumber)'
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish HTML report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish test results'
            condition: always()
            inputs:
              targetPath: 'test-results'
              artifact: 'test-results'
              publishLocation: 'pipeline'
      
      - job: TestLocal
        displayName: 'Test Locally (Fallback)'
        dependsOn: TestOnCloud
        condition: failed()
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'
          
          - script: npm test -- --project=chromium
            displayName: 'Run Playwright tests locally'
            env:
              BASE_URL: $(BASE_URL)
              CI: true
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/junit.xml'
              testRunTitle: 'Playwright Tests (Local) - $(Build.BuildNumber)'

  - stage: Report
    displayName: 'Generate Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: GenerateReport
        displayName: 'Generate Test Report'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - download: current
            artifact: playwright-report
          
          - script: |
              echo "Test report available in artifacts"
              echo "Build: $(Build.BuildNumber)"
              echo "Status: $(Agent.JobStatus)"
            displayName: 'Report summary'

